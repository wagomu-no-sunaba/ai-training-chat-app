# 実装計画

## タスク概要

この実装計画は、OpenRouterとVercel AI SDK 5.0を統合したチャットアプリケーションを段階的に構築するためのタスクリストです。各タスクは要件とトレーサビリティを持ち、順次実装することで完全なシステムを構築します。

---

## 実装タスク

- [ ] 1. プロジェクト基盤とAPI基本設定
- [x] 1.1 環境変数とOpenRouter統合の準備
  - 環境変数ファイルを作成し、OpenRouter APIキーの設定場所を確保
  - OpenRouterプロバイダーの初期化ロジックを実装
  - APIキーの検証と適切なエラーハンドリングを追加
  - 環境変数が未設定の場合の明確なエラーメッセージを提供
  - _Requirements: 4.1, 4.2_

- [x] 1.2 チャットAPIルートの基本実装
  - `/api/chat` エンドポイントを作成
  - リクエストボディの型定義とバリデーション機能を実装
  - OpenRouterプロバイダーを使用したstreamText統合
  - ストリーミングレスポンスの基本フローを確立
  - _Requirements: 2.1, 4.3_

- [x] 1.3 APIリクエスト検証とエラーレスポンス
  - メッセージ配列の検証ロジック（非空チェック、role検証）を実装
  - 各種エラーケースに対応したHTTPステータスコードとレスポンスを定義
  - エラーログ記録機能を追加
  - 構造化されたエラーレスポンス型を作成
  - _Requirements: 2.3_

- [ ] 2. フロントエンドチャットUIの構築
- [x] 2.1 チャットメッセージ表示コンポーネント
  - メッセージリスト表示コンポーネントを作成
  - ユーザーメッセージとアシスタントメッセージの視覚的区別を実装
  - 時系列順のメッセージ表示機能を実装
  - 自動スクロール機能（最新メッセージへの追従）を追加
  - _Requirements: 1.1, 1.4_

- [x] 2.2 メッセージ入力インターフェース
  - テキスト入力フィールドと送信ボタンを含む入力コンポーネントを作成
  - 送信時の入力フィールドクリア機能を実装
  - エンターキーでの送信サポートを追加
  - 送信中の入力無効化機能を実装
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 2.3 useChatフックの統合とステート管理
  - Vercel AI SDKのuseChatフックをチャットUIに統合
  - メッセージ送信、ストリーミング状態、エラー状態の管理を実装
  - `/api/chat` エンドポイントへの接続設定
  - ストリーミングレスポンスのリアルタイムUI更新を実装
  - _Requirements: 2.1, 2.2, 3.1, 3.2, 5.1, 5.2_

- [ ] 3. ストリーミングレスポンスと会話管理
- [x] 3.1 ストリーミング中のUI状態表示
  - ローディングインジケーターまたはタイピングアニメーションを実装
  - ストリーミング中の送信ボタン無効化を実装
  - ストリーミング状態に応じた視覚的フィードバックを追加
  - _Requirements: 2.4, 3.2_

- [x] 3.2 ストリーミング完了と履歴管理
  - ストリーミング完了時のメッセージ確定処理を実装
  - 会話履歴の保持と表示機能を実装
  - メッセージ履歴のコンテキスト送信機能を確認
  - _Requirements: 3.3, 5.1, 5.3_

- [x] 3.3 ストリーミングエラーハンドリング
  - ストリーミング中断時のエラー表示機能を実装
  - 部分的なレスポンスの保持機能を実装
  - エラー状態からの回復UI（再試行ボタン等）を追加
  - _Requirements: 3.4_

- [x] 4. エラーハンドリングとユーザーフィードバック
- [x] 4.1 クライアントサイドエラー表示
  - APIエラー時のユーザー向けエラーメッセージ表示を実装
  - エラータイプに応じた適切なメッセージとアクションを提供
  - エラー状態のクリア機能を実装
  - _Requirements: 2.3_

- [x] 4.2 認証エラーとレート制限の処理
  - 401エラー時のAPIキー設定ガイダンスを表示
  - 429エラー時の待機時間通知と再試行機能を実装
  - その他HTTPエラー（500, 502, 504）の適切な表示
  - _Requirements: 2.3_

- [ ] 5. UIスタイリングとレスポンシブ対応
- [x] 5.1 チャットUIのスタイリング
  - Tailwind CSSを使用したチャットレイアウトの実装
  - メッセージバブル、入力フィールド、ボタンのスタイリング
  - ダークモード対応（既存テーマとの統合）
  - _Requirements: 1.1_

- [x] 5.2 レスポンシブデザインとアクセシビリティ
  - モバイルビューでの適切なレイアウト調整
  - タブレット・デスクトップビューの最適化
  - キーボードナビゲーションとARIAラベルの追加
  - _Requirements: 1.1_

- [ ] 6. 会話クリア機能と追加UI機能
- [x] 6.1 会話履歴のクリア機能
  - 会話をクリアするボタンまたはメニュー項目を追加
  - クリア実行時の確認ダイアログを実装
  - クリア後の初期状態への復帰を実装
  - _Requirements: 5.4_

- [ ] 6.2 モデル選択機能（オプション）
  - 使用するAIモデルを選択できるUIコンポーネントを実装
  - 選択されたモデル名のAPIへの送信機能を実装
  - デフォルトモデルの設定
  - _Requirements: 4.4_

- [ ] 7. テストの実装
- [x] 7.1 ユニットテストの作成
  - メッセージ表示コンポーネントのレンダリングテスト
  - 入力コンポーネントの送信ロジックテスト
  - APIルートのバリデーション機能テスト
  - エラーハンドリングロジックのテスト
  - _Requirements: All requirements（品質保証）_

- [x] 7.2 統合テストの作成
  - useChat hookとAPI Routeの統合テスト
  - ストリーミングレスポンスのエンドツーエンドテスト
  - エラーケースの統合テスト
  - _Requirements: All requirements（品質保証）_

- [ ] 7.3 E2Eテストの作成
  - チャットメッセージ送信フローのE2Eテスト
  - ストリーミングレスポンス表示のE2Eテスト
  - エラーハンドリングのE2Eテスト
  - _Requirements: All requirements（品質保証）_

- [ ] 8. 最終統合と動作確認
- [x] 8.1 全機能の統合確認
  - すべてのコンポーネントとAPIの連携を確認
  - エラーケースの総合的な動作確認
  - パフォーマンスの基本確認（TTFB、ストリーミングレート）
  - _Requirements: All requirements_

- [x] 8.2 型定義の最終確認とリファクタリング
  - すべての型定義が適切に設定されているか確認
  - any型の使用がないか確認
  - コードの可読性と保守性の最終チェック
  - _Requirements: 設計原則（TypeScript厳格型定義）_

---

## 要件カバレッジマトリクス

| 要件ID | 要件概要 | 対応タスク |
|--------|----------|-----------|
| 1.1 | チャット入力フィールドとメッセージ表示エリアを表示 | 2.1, 2.2, 5.1, 5.2 |
| 1.2 | ユーザーメッセージをメッセージ履歴に追加 | 2.2 |
| 1.3 | 入力フィールドをクリア | 2.2 |
| 1.4 | メッセージを時系列順に表示 | 2.1 |
| 2.1 | OpenRouter API経由でAIモデルにリクエストを送信 | 1.2, 2.3 |
| 2.2 | レスポンスをメッセージ履歴に追加 | 2.3 |
| 2.3 | エラーメッセージをユーザーに表示 | 1.3, 4.1, 4.2 |
| 2.4 | ローディング状態を表示 | 3.1 |
| 3.1 | ストリーミング形式でレスポンスの受信を開始 | 2.3 |
| 3.2 | 受信したテキストを逐次表示 | 2.3, 3.1 |
| 3.3 | 完全なレスポンスをメッセージ履歴に保存 | 3.2 |
| 3.4 | エラー状態を表示し、部分的なレスポンスを保持 | 3.3 |
| 4.1 | @openrouter/ai-sdk-providerを使用してOpenRouterインスタンスを作成 | 1.1 |
| 4.2 | 環境変数からAPIキーを読み込む | 1.1 |
| 4.3 | streamText()関数を使用してレスポンスを生成 | 1.2 |
| 4.4 | 使用するモデル名を指定できる | 6.2 |
| 5.1 | メッセージを会話履歴に追加 | 2.3, 3.2 |
| 5.2 | 会話履歴をコンテキストとして含める | 2.3 |
| 5.3 | すべてのメッセージ（ユーザーとAI）を保持 | 3.2 |
| 5.4 | すべてのメッセージ履歴を削除 | 6.1 |

---

## 実装ガイドライン

### 実装順序
1. バックエンド基盤（タスク1）から開始し、APIの動作を確認
2. フロントエンド基本UI（タスク2）を構築し、ユーザーインターフェースを確立
3. ストリーミングと会話管理（タスク3）でコア機能を完成
4. エラーハンドリング（タスク4）で堅牢性を向上
5. スタイリングとUX（タスク5）で使いやすさを向上
6. 追加機能（タスク6）で利便性を向上
7. テスト（タスク7）で品質を保証
8. 統合と最終確認（タスク8）で完成度を高める

### タスクサイズ目安
- サブタスク（例: 1.1, 2.1）: 1-3時間
- メジャータスク（例: 1, 2）: グループ全体で半日〜1日

### コミット推奨タイミング
- 各サブタスク完了時
- 動作確認が取れた時点
- メジャータスク完了時

### 注意事項
- 設計ドキュメント（design.md）を参照し、型定義とアーキテクチャに従う
- any型を使用せず、明示的な型定義を徹底
- エラーハンドリングを適切に実装
- テストは各タスクの実装後に並行して作成推奨
